(function(t){"use strict";t.widget("cp.WPCP_OutoftheBox_Carousel",{options:{listtoken:null},_create:function(){this.options.topContainer=this.element.parent(),this.options.mainContainer=this.element.find(".wpcp-carousel"),this.options.loadingContainer=this.element.find(".loading"),this.options.carouselContainer=this.element.find(".wpcp-carousel-main-container"),this.options.slideTemplate=this.element.find(".wpcp-carousel-item-template .wpcp-carousel-item"),this.options.supportTouch=!!("ontouchstart"in window)&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||navigator.maxTouchPoints>1,this.options.listtoken=this.element.attr("data-token"),this.options.account_id=this.element.attr("data-account-id"),this.options.drive_id=this.element.attr("data-drive-id"),this.images={},this.images_total=0,this.carousel=!1,this.is_paused=!1,this.playTimeout=null;let t=parseFloat(this.options.carouselContainer.attr("data-items"));this.options.carousel={container:this.options.carouselContainer.get(0),autoWidth:"horizontal"===this.options.carouselContainer.attr("data-axis")&&"1"===this.options.carouselContainer.attr("data-auto-size"),autoHeight:"vertical"===this.options.carouselContainer.attr("data-axis")&&"1"===this.options.carouselContainer.attr("data-auto-size"),mode:"carousel",axis:this.options.carouselContainer.attr("data-axis"),items:1,slideBy:1,edgePadding:0,gutter:0,loop:!0,center:!1,speed:parseInt(this.options.carouselContainer.attr("data-speed")),controls:"1"===this.options.carouselContainer.attr("data-navigation-arrows"),controlsPosition:"bottom",controlsText:['<i class="eva eva-chevron-left"></i>','<i class="eva eva-chevron-right"></i>'],autoplay:"1"===this.options.carouselContainer.attr("data-autoplay"),autoplayDirection:this.options.carouselContainer.attr("data-autoplayDirection"),autoplayHoverPause:"1"===this.options.carouselContainer.attr("data-autoplayHoverPause"),autoplayTimeout:parseInt(this.options.carouselContainer.attr("data-autoplayTimeout")),autoplayText:["▶","❚❚"],autoplayButtonOutput:!1,nav:!1,navPosition:"bottom",arrowKeys:!0,mouseDrag:!0,swipeAngle:!1,responsive:{630:{items:t<2?1:2,slideBy:t<2?1:2,gutter:"0"===this.options.carouselContainer.attr("data-auto-size")?this.options.carouselContainer.attr("data-gutter"):1,nav:"1"===this.options.carouselContainer.attr("data-nav"),mouseDrag:!0,center:"1"===this.options.carouselContainer.attr("data-center")},900:{slideBy:parseFloat(this.options.carouselContainer.attr("data-slideBy"))<=t?parseFloat(this.options.carouselContainer.attr("data-slideBy")):t,items:t}}},this._initiate()},_destroy:function(){return this._super()},_setOption:function(t,o){this._super(t,o)},_initiate:function(){let t=this;var o=t.buildRequest();o({},t)},_initCarousel:function(o){let e=this;if(!1===o)return e.options.mainContainer.find(".wpcp-carousel-preloading").remove(),void e.showError();t.isEmptyObject(o)?e.showError():(e.images_total=o.total,e.addImages(o.images),e.options.carousel.responsive[900].items>e.images_total&&(e.options.carousel.responsive[900].items=e.images_total,e.options.carousel.responsive[630].items=e.images_total<2?1:2),e.carousel=tns(e.options.carousel),e.carousel.pause(),e.carousel.events.on("indexChanged",function(o,i){e.is_paused=!1;let a=o.index-o.items<0?0:o.index-o.items,n=e.options.carousel.autoplayTimeout<500?5:2*o.items+1;"1"==e.options.carouselContainer.attr("data-auto-size")&&(n=parseFloat(e.options.carouselContainer.attr("data-items")));let s=Array.prototype.slice.call(o.slideItems,a,o.index+2*n),r=t(s).find(".wpcp-carousel-item-bg[data-src]");0!==r.length&&(e.options.mainContainer.find(".tns-slide-active .wpcp-carousel-item-bg.wpcp-carousel-item-bg-loading").length&&(e.is_paused=!0,e.carousel.pause()),e._fetchImages(r))}),e.carousel.events.emit("indexChanged",e.carousel.getInfo()),e.is_paused=!0,e.options.mainContainer.addClass("wpcp-carousel-loaded"),e.options.mainContainer.find(".wpcp-carousel-preloading").remove(),e._initLightbox(),e.setEvents(),"1"===e.element.attr("data-lightboxopen")&&e.element.find("div.ilightbox-group:visible").first().trigger("click"))},setEvents:function(){let o=this;t(o.options.carouselContainer).on({click:function(e){return!1===o.options.supportTouch||t(this).hasClass("is-touched")?(e.stopPropagation(),void(o.options.supportTouch?t(this).find(".entry_action_view").trigger("itap"):t(this).find(".entry_action_view").trigger("click"))):(o.options.carouselContainer.find(".wpcp-carousel-item.is-touched").removeClass("is-touched"),t(this).addClass("is-touched"),!1)}},".wpcp-carousel-item"),t(o.options.carouselContainer).on({click:function(e){var i=t(this).parents(".wpcp-carousel-item");return e.stopPropagation(),o.options.main._actionDownloadEntry(i,e)}},".entry_action_download"),t(o.options.carouselContainer).on({click:function(e){var i=t(this).parents(".wpcp-carousel-item");e.stopPropagation(),o.options.main._actionShareEntry(i,e)}},".entry_action_shortlink");let e=o.options.carouselContainer[0].querySelectorAll(".entry-description-button");t(e).on("click",function(t){t.stopPropagation()}),tippy(e,{trigger:"mouseenter focus click",arrow:!1,offset:0,content:function(t){return t.querySelector(".tippy-content-holder").innerHTML},maxWidth:350,allowHTML:!0,placement:"bottom",delay:[100,null],interactiveBorder:15,appendTo:o.element[0],moveTransition:"transform 0.2s ease-out",interactive:!0,onShow:function(t){tippy.hideAll()},onHide:function(t){}})},buildRequest:function(){let t=this;var o=o=>{t._initCarousel(o)};return t.options.main._pipeline({url:OutoftheBox_vars.ajax_url,type:"POST",dataType:"json",data:function(o){return o.action="outofthebox-get-gallery",o.type="carousel",o.sort=t.element.attr("data-sort"),o.account_id=t.options.account_id,o.listtoken=t.options.listtoken,o.id=t.element.attr("data-id"),o._ajax_nonce=OutoftheBox_vars.gallery_nonce,o}},o)},addImages:function(o){let e=this;const i=Math.round(t(".wpcp-carousel").height()-20),a=Math.round(t(".wpcp-carousel").width());t.each(o,function(){var t=this;let o=e.options.slideTemplate.clone(),n=o.find(".wpcp-carousel-item-bg").get(0);if(n.setAttribute("data-src",t.url),o.attr("data-id",t.id).attr("data-name",t.name),e.options.carousel.autoWidth&&o.children().first().css({width:t.width&&t.height?Math.round(i*t.width/t.height):i,height:i}),e.options.carousel.autoHeight&&o.children().first().css({width:a,height:t.width&&t.height?Math.round(a*t.height/t.width):a}),o.find(".wpcp-carousel-item-date span").text(t.last_edited_time_str),o.find(".wpcp-carousel-item-title span").html(t.name),t.description?(o.find(".wpcp-carousel-item-description, .description-text").html(t.description),o.addClass("wpcp-has-description")):o.find(".wpcp-carousel-item-description").remove(),t.download_url?o.find(".entry_action_download").attr("href",t.download_url):o.find(".entry_action_download").remove(),t.lightbox_link){let i=o.find(".entry_action_view");i.addClass("ilightbox-group"),i.attr("data-src",t.url),i.attr("data-type","image"),i.attr("rel","ilightbox['"+e.options.listtoken+"']"),i.attr("data-options","thumbnail:'"+t.url+"'"),t.description&&i.attr("data-caption",t.description)}e.images[t.id]=o,e.options.carouselContainer.append(o)})},_fetchImages:function(o){let e=this;t.each(o,function(){t(this).css({"background-image":'url("'+t(this).attr("data-src")+'")'}),t(this).addClass("wpcp-carousel-item-bg-loading")});let i=imagesLoaded(e.options.carouselContainer.get(0),{background:".wpcp-carousel-item-bg-loading"});i.on("progress",function(o,i){var a=i.isLoaded?"loaded":"broken";let n=t(i.element);n.removeClass("wpcp-carousel-item-bg-loading"),"broken"!==a&&(n.removeClass("preloading").removeAttr("data-src"),n.prev(".preloading").remove(),n.css("opacity",1),n.parents(".wpcp-carousel-item").find(".wpcp-carousel-item-overlay").addClass("wpcp-visible"),n.parents(".wpcp-carousel-item").find(".wpcp-carousel-item-text").css("opacity",1),clearTimeout(e.playTimeout))}).on("done",function(t){}).on("always",function(t){e.is_paused&&(e.playTimeout=setTimeout(()=>{e.carousel.play()},e.options.carousel.autoplayTimeout))})},showError:function(){let t=this;t.options.carouselContainer.html('<p style="text-align:center;">'+t.options.str_no_filelist+"</p>")},_initLightbox:function(){let o,e=this,i="1"===e.element.attr("data-lightboxnav"),a="1"===e.element.attr("data-lightboxthumbs"),n=!1,s=!1;"click"===e.options.lightbox_showcaption?o=s="click":"mouseenter"===e.options.lightbox_showcaption?(o=e.options.lightbox_showcaption,s="mouseleave"):"false"==e.options.lightbox_showcaption||"No"==e.options.lightbox_showcaption?(o=!1,s=!1):(n=!0,o=!0,s=!0);let r={WPCP:e,skin:"OutoftheBox wpcp-lightbox "+e.options.lightbox_skin,path:e.options.lightbox_path,attr:"data-src",maxScale:1,minScale:.05,infinite:!0,slideshow:{pauseOnHover:!1,pauseTime:parseInt(e.options.carouselContainer.attr("data-autoplayTimeout")),startPaused:"1"!==e.element.attr("data-slideshow")},controls:{slideshow:i,arrows:i,thumbnail:a},caption:{start:n,show:o,hide:s},headerHeight:50,header:{start:!1,show:!1,hide:!1},thumbnails:{normalOpacity:.9,activeOpacity:1,maxHeight:100},show:{effect:!1},hide:{effect:!1},overlay:{opacity:1},keepAspectRatio:!0,callback:{onBeforeLoad:function(o,i){t(".ilightbox-holder").attr("data-token",e.options.listtoken)},onOpen:function(){e.carousel.pause()},onHide:function(){let o=this.ui.currentElement.find(".ilightbox-container [src]"),i=t('.entry_action_view[data-src="'+o.attr("src")+'"]:first').parents(".wpcp-carousel-item").index();e.carousel.goTo(i-e.carousel.getInfo().cloneCount),e.carousel.play()},onShow:function(o,i){let a=this;new LazyLoad({data_src:window.devicePixelRatio>1?"src-retina":"src",unobserve_entered:!0,use_native:!1,elements_selector:".ilightbox-thumbnail img.preloading",class_applied:"wpcp-lazy-applied",class_loading:"wpcp-lazy-loading",class_loaded:"wpcp-lazy-loaded",class_error:"wpcp-lazy-error",callback_loaded:function(o){t(o).removeClass("preloading preloading-lightbox-thumbnail"),t(o).prev(".preloading").remove(),t(o).parent().data({naturalWidth:o.width,naturalHeight:o.height}),a.positionThumbnails(null,null,null)},callback_load:function(o){t(o).removeClass("preloading preloading-lightbox-thumbnail"),t(o).prev(".preloading").remove(),t(o).parent().data({naturalWidth:o.width,naturalHeight:o.height}),a.positionThumbnails(null,null,null)}}),t(".ilightbox-container .ilightbox-wrapper, .ilightbox-container img, .ilightbox-container video, .ilightbox-container audio").on("contextmenu",function(t){return"Yes"===e.options.lightbox_rightclick||(t.preventDefault(),t.stopPropagation(),!1)});let n=o.currentElement.find(".ilightbox-container [src]");if(n.length>0&&1!==n.data("logged")){var s=t('.entry_action_view[data-src="'+n.attr("src")+'"]:first').parents(".wpcp-carousel-item").attr("data-id");n.data("logged",1),e.options.main._logEvent("log_preview_event",s)}}},errors:{loadImage:e.options.str_imgError_title,loadContents:e.options.str_xhrError_title},text:{next:e.options.str_next_title,previous:e.options.str_previous_title,slideShow:e.options.str_startslideshow},candownload:!1};if(i){t.isEmptyObject(this.lightBox)||e.lightBox.destroy();let o=e.element.find(".ilightbox-group");e.lightBox=o.WPCP_iLightBox(r)}else t.isEmptyObject(this.lightBox)||t.each(this.lightBox,function(){this.destroy()}),e.lightBox=[],e.element.find(".ilightbox-group").each(function(){e.lightBox.push(t(this).WPCP_iLightBox(r))})}})})(jQuery);